!function(t,e){function n(t){var e={},n={type:"contentType",name:"query",withParents:"withParent"}
	t.parentType&&t.parentId&&(e[t.parentType+"Id"]=t.parentId)
	for(var a in t)r(t,a)&&t[a]&&(e[r(n,a)?n[a]:a]=t[a])
	return e}function r(t,e){return t.hasOwnProperty(e)}function a(t){var n=e.console
	n&&n.error&&n.error(t)}t.fias={},function(){var e="https:"
	t.fias.url=e+"//kladr-api.ru/api.php",t.fias.timeout=3e3}()
	var i=[],o=function(){for(;i.length>5;){var t=i.shift()
		t.abort()}}
	t.fias.type={region:"region",district:"district",city:"city",street:"street",building:"building"},t.fias.typeCode={city:1,settlement:2,village:4},t.fias.validate=function(e){var n=t.fias.type
		switch(e.type){case n.region:case n.district:case n.city:if(e.parentType&&!e.parentId)return a("parentId undefined"),!1
			break
			case n.street:if(e.parentType!=n.city&&e.parentType!=n.street)return a('parentType must equal "city" or "street"'),!1
				if(!e.parentId)return a("parentId undefined"),!1
				break
			case n.building:if(!e.zip){if(!~t.inArray(e.parentType,[n.street,n.city]))return a('parentType must equal "street" or "city"'),!1
				if(!e.parentId)return a("parentId undefined"),!1}break
			default:if(!e.oneString)return a("type incorrect"),!1}return e.oneString&&e.parentType&&!e.parentId?(a("parentId undefined"),!1):e.typeCode&&e.type!=n.city?(a('type must equal "city"'),!1):e.limit<1?(a("limit must greater than 0"),!1):!0},t.fias.api=function(e,r){if(!r)return void a("Callback undefined")
		if(!t.fias.validate(e))return void r([])
		var l=setTimeout(function(){r([]),l=null},t.fias.timeout)
		!e.token&&t.fias.token&&(e.token=t.fias.token),o()
		var u=t.ajax({url:t.fias.url+"?callback=?",type:"get",data:n(e),dataType:"jsonp"})
		i.push(u),u.done(function(t){l&&(r(t.result||[]),clearTimeout(l))})},t.fias.check=function(e,n){return n?(e.withParents=!1,e.limit=1,void t.fias.api(e,function(t){n(t&&t.length?t[0]:!1)})):void a("Callback undefined")}}(jQuery,window),function(t,e,n,r){function a(a,i){function c(t,e){return t.isGet?p.get(t.str[0]):(p.set(t),e(),r)}var p=function(){var e="kladr-data",n=a.data(e)
	return n||(n=t.extend({},u,s),a.data(e,n)),{set:function(t){if(t.obj)for(var r in t.obj)l(t.obj,r)&&l(u,r)&&(n[r]=t.obj[r])
		else t.str&&!t.isGet&&l(u,t.str[0])&&(n[t.str[0]]=t.str[1])
			a.data(e,n)},get:function(t){return l(u,t)||l(s,t)?n[t]:r},_set:function(t,r){n[t]=r,a.data(e,n)},_get:function(t){return l(n,t)?n[t]:r}}}()
	return c(i,function(){function i(r){var i=t(n.getElementById("kladr_autocomplete"))
		i.length||(i=t('<div id="kladr_autocomplete"></div>').appendTo(n.body))
		var l=A("guid")
		l?(V=i.find(".autocomplete"+l),F=i.find(".spinner"+l),t(e).off(L),a.off(L),V.off(L)):(l=o(),P("guid",l),a.attr("autocomplete","off"),V=t('<ul class="autocomplete'+l+' autocomplete" style="display: none;"></ul>').appendTo(i),F=t('<div class="spinner'+l+' spinner" style="display: none;"></div>').appendTo(i),b(),d(),w()),r()}function s(e,n){var r,a,i,o
		V.empty()
		for(var l=0;l<e.length;l++){r=e[l],a=A("valueFormat")(r,n),i=A("labelFormat")(r,n)
			var u=a.replace(/(["])/g,"\\$1"),s=t("<div>"+i+"</div>").text().replace(/(["])/g,"\\$1")
			o=t('<a data-val="'+u+'">'+i+"</a>"),o.data("kladr-object",r),t('<li title="'+s+'"></li>').append(o).appendTo(V)}}function c(){var e,n,r
		V.empty(),e="",n=u.noResultText,null!=n&&""!=n&&(r=t('<a data-val="'+e+'">'+n+"</a>"),r.data("kladr-object",{}),t("<li></li>").append(r).appendTo(V))}function d(){var t=a.offset(),e=a.outerWidth(),n=a.outerHeight()
		if(t&&(d.top!=t.top||d.left!=t.left||d.width!=e||d.height!=n)){d.top=t.top,d.left=t.left,d.width=e,d.height=n,V.css({top:t.top-1+n+"px",left:t.left})
			var r=V.outerWidth()-V.width()
			V.width(e-r)
			var i=F.width(),o=F.height()
			F.css({top:t.top+(n-o)/2-1,left:t.left+e-i-2})}}function v(e){if(!(e.which>8&&e.which<46)){if(a.data(R,!1),!T("open_before"))return y(),r
		x(null)
		var n=a.val()
		if(!t.trim(n))return B(!1),y(),r
		var i=C(n)
		if(!T("send_before",i))return y(),r
		I(),T("send"),A("source")(i,function(e){return"Free"===e[0].id&&e.shift(),T("receive",e),a.is(":focus")?t.trim(a.val())&&e.length?(G=!0,s(e,i),d(),j(),V.slideDown(50),T("open"),r):(j(),x(null),c(),d(),V.slideDown(50),T("open"),G=!1,r):(j(),y(),r)})}}function y(){T("close_before")&&(V.empty().hide(),T("close"))}function h(t){var e=V.find("li.active")
		switch(t.which){case f.up:e.length?(e.removeClass("active"),e.prev().length&&(e=e.prev())):e=V.find("li").last(),function(){var t=V.scrollTop(),n=V.offset(),r=e.outerHeight(),a=e.offset()
			a.top-n.top<0&&V.scrollTop(t-r)}(),e.addClass("active"),m()
			break
			case f.down:e.length?(e.removeClass("active"),e.next().length&&(e=e.next())):e=V.find("li").first(),e.length&&!function(){var t=V.scrollTop(),n=V.height(),r=V.offset(),a=e.outerHeight(),i=e.offset()
				i.top-r.top+a>n&&V.scrollTop(t+a)}(),e.addClass("active"),m()
				break
			case f.enter:y()}}function g(e){var n=t(e)
		n.is("a")&&(n=n.parents("li")),n.addClass("active"),m(),y()}function m(){if(T("select_before")){var t=V.find(".active a")
		t.length&&(a.val(t.attr("data-val")).data(R,!0),B(!1),x(t.data("kladr-object")),T("select",A("current")))}}function k(){function e(t,e){B(e),x(t)}if(A("verify")&&T("check_before")){var n=t.trim(a.val())
		if(!n)return e(null,!1),r
		if(A("current"))return B(!1),r
		var i=C(n)
		if(i.withParents=!1,i.limit=10,!T("send_before",i))return e(null,!1),T("check",null),r
		I(),T("send"),A("source")(i,function(n){function o(t,n){j(),e(t,n)}if(T("receive"),!t.trim(a.val()))return o(null,!1),r
			for(var l=i.name.toLowerCase(),u=null,s=null,f=0;f<n.length;f++)if(u=n[f].name.toLowerCase(),l==u){s=n[f]
				break}s&&a.val(A("valueFormat")(s,i)),o(s,!s),T("check",s)})}}function b(){function e(){a.attr(i,!0)}function n(t,e,n){t?a.val(A("valueFormat")(t,e)):B(!0),x(t,n),a.removeAttr(i)}var r={setValue:function(e,n){return"object"===t.type(e)?r.setValueByObject(e,n):"number"===t.type(e)?r.setValueById(e,n):"string"===t.type(e)?r.setValueByName(e,n):e?r:r.clear(n)},setValueByName:function(a,i){if(a=t.trim(a+"")){var o=C("")
			if(o.name=_(a),o.withParents=!1,o.limit=10,!T("send_before",o))return n(null,o,i),r
			e(),T("send"),A("source")(o,function(t){T("receive")
				for(var e=o.name.toLowerCase(),r=null,a=null,l=0;l<t.length;l++)if(r=t[l].name.toLowerCase(),e==r){a=t[l]
					break}n(a,o,i)})}return r},setValueById:function(a,i){var o=C("")
			return o.parentType=o.type,o.parentId=a,o.limit=1,e(),t.fias.api(o,function(t){t.length?n(t[0],o,i):n(null,o,i)}),r},setValueByObject:function(t,e){return n(t,C(""),e),r},clear:function(t){return n(null,null,t),r}},i="data-kladr-autofill-lock"
		P("controller",r)}function w(){function e(){var e=a.val()
		if(e){var n,r=C(e),i=r.type,o=r.parentType,l=t.fias.type,u=!0,s=A("controller").setValueByName
			return i==l.street&&o!=l.city&&(u=!1),i!=l.building||~t.inArray(o,[l.street,l.city])||(u=!1),n=a.attr("data-kladr-autofill-lock"),n&&A("current")&&u&&s(e),!!A("current")}return!1}var n=0
		!function r(){++n>5||e()||setTimeout(r,100)}()}function T(e,n,r){if(!e)return!0
		var i=e.replace(/_([a-z])/gi,function(t,e){return e.toUpperCase()})
		return a.trigger("kladr_"+e,n),"function"===t.type(A(i))?A(i).call(a.get(0),n,r)!==!1:!0}function I(){A("spinner")&&A("showSpinner")(F)}function j(){A("spinner")&&A("hideSpinner")(F)}function C(t){var e,n={},r=["token","type","typeCode","parentType","parentId","oneString","withParents","limit","strict"]
		for(e=0;e<r.length;e++)n[r[e]]=A(r[e])
		n.name=_(t)
		var a,i=A("parentInput")
		return i&&(a=S(i,n.type),a&&(n.parentType=a.type,n.parentId=a.id)),n.oneString&&(n.withParents=!0),n}function S(e,n){var r,a=t.fias.getInputs(e),i=t.fias.type,o={},u=null
		a.each(function(){var e,n=t(this);(e=n.attr("data-kladr-id"))&&(o[n.attr("data-kladr-type")]=e)})
		for(r in i){if(r==n)return u
			l(i,r)&&o[r]&&(u={type:r,id:o[r]})}return u}function _(t){for(var e="abcdefghijklmnopqrstuvwxyz",n=t.toLowerCase(),r=0;r<n.length;r++)if(~e.indexOf(n[r]))return B(!0),t
		return B(!1),t}function x(t,e){var n=A("current");(n&&n.id)!==(t&&t.id)&&(P("current",t),t&&t.id?a.attr("data-kladr-id",t.id):a.removeAttr("data-kladr-id"),A("oneString")&&t&&t.contentType&&a.attr("data-kladr-type",t.contentType),T("change",t,e))}function B(t){t?a.addClass("kladr-error"):a.removeClass("kladr-error")}function A(t){return p._get(t)}function P(t,e){p._set(t,e)}var V=null,F=null,G=!1,L=".kladr",R="kladrInputChange"
		i(function(){var n=!1,i=!0,o=""
			a.attr("data-kladr-type",A("type")||"").attr("data-kladr-one-string",A("oneString")||null).on("keyup"+L,v).on("keydown"+L,h).on("blur"+L,function(){!n&&a.data(R)&&o!=a.val()&&a.change()}).on("blur"+L+" change"+L,function(t){return n?r:("change"==t.type&&(o=a.val()),i&&(i=!1,k()),!G&&u.checkEmptyRespone&&a.val(""),y(),!1)}).on("focus"+L,function(){i=!0}),V.on("touchstart"+L+" mousedown"+L,"li, a",function(t){t.preventDefault(),n=!0,g(this),n=!1}),t(e).on("resize"+L,d)})})}function i(e,n){var a={obj:!1,str:!1,isGet:!1}
	return"object"===t.type(e)?(a.obj=e,a):("string"===t.type(e)&&(a.str=[e,n],a.isGet=n===r),a)}function o(){return o.guid?++o.guid:o.guid=1}function l(t,e){return t.hasOwnProperty(e)}var u={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,noResultText:null,checkEmptyRespone:!1,strict:null,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,receive:null,select:null,check:null,change:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(e,n){t.fias.api(e,n)},labelFormat:function(e,n){var r,a=function(t){var e=["-","[","]","/","{","}","(",")","*","+","?",".","\\","^","$","|"],r=RegExp("["+e.join("\\")+"]","g"),a=n.name.toLowerCase().replace(r,"\\$&"),i=RegExp(a,"gi")
		return t.replace(i,"<strong>$&</strong>")}
		if(n.oneString)return e.parents?(r=[].concat(e.parents),r.push(e),a(t.fias.buildAddress(r))):a((e.typeShort?e.typeShort+". ":"")+e.name)
		var i=""
		if(e.typeShort&&(i+=e.typeShort+". "),i+=e.name,i=a(i),e.parents)for(var o=e.parents.length-1;o>-1;o--){var l=e.parents[o]
			l.name&&(i&&(i+="<small>, </small>"),i+="<small>"+l.name+" "+l.typeShort+".</small>")}return i},valueFormat:function(e,n){var r
		return n.oneString?e.parents?(r=[].concat(e.parents),r.push(e),t.fias.buildAddress(r)):(e.typeShort?e.typeShort+". ":"")+e.name:e.name},showSpinner:function(t){var e=-.2,n=setInterval(function(){return t.is(":visible")?(t.css("background-position","0% "+e+"%"),e+=5.555556,e>95&&(e=-.2),r):(clearInterval(n),n=null,r)},30)
		t.show()},hideSpinner:function(t){t.hide()}},s={current:null,controller:null},f={up:38,down:40,enter:13}
	t.fias=t.extend(t.fias,{setDefault:function(t,e){var n=i(t,e)
			if(n.obj)for(var r in n.obj)l(u,r)&&(u[r]=n.obj[r])
			else n.str&&!n.isGet&&l(u,n.str[0])&&(u[n.str[0]]=n.str[1])},getDefault:function(t){return l(u,t)?u[t]:r},getInputs:function(e){var r=t(e||n.body),a="[data-kladr-type]"
			return r.filter(a).add(r.find(a))},setValues:function(e,n,a){var i,o,u="kladr_change.setvalues",s=t.fias.type,f={},c={}
			if(~t.inArray(t.type(e),["object","array"])){t.each(e,function(t,e){if(e){var n=e.contentType||e.type||t
				l(s,n)&&(f[n]=e)}})
				for(o in s)l(s,o)&&f[o]&&(c[o]=f[o])
				i=t.fias.getInputs(n),function p(){var t,e,n
					for(e in c)if(l(c,e)){n=c[e],delete c[e]
						break}if(e)return t=i.filter('[data-kladr-type="'+e+'"]'),t.length?(t.on(u,function(){t.off(u),p()}).fias("controller").setValue(n,a),r):(p(),r)}()}},getAddress:function(e,n){var r,a=t.fias.getInputs(e),i=t.fias.type,o={},u={}
			a.each(function(){var e,n,r,a=t(this)
				if(a.attr("data-kladr-id"))if(e=a.fias("current"),a.attr("data-kladr-one-string")&&e.parents)for(n=[].concat(e.parents),n.push(e),r=0;r<n.length;r++)o[n[r].contentType]=n[r]
				else o[a.attr("data-kladr-type")]=e
				else o[a.attr("data-kladr-type")]=a.val()})
			for(r in i)l(i,r)&&o[r]&&(u[r]=o[r])
			return(n||t.fias.buildAddress)(u)},buildAddress:function(e){var n=[],r="",a=""
			return t.each(e,function(e,i){var o,l="",u=""
				if("object"===t.type(i)){for(o=0;o<n.length;o++)if(n[o]==i.id)return
					n.push(i.id),l=i.name,u=i.typeShort+". ",a=i.zip||a}else l=i
				r&&(r+=", "),r+=u+l}),r=(a?a+", ":"")+r}}),t.fn.fias=function(e,n){var o=i(e,n),l=null
		return this.each(function(){var e=a(t(this),o)
			return o.isGet?(l=e,!1):r}),o.isGet?l:this}}(jQuery,window,document)
